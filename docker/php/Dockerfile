########################################################################################################################
# Stage: composer
########################################################################################################################

FROM composer:1.10.1 as composer

########################################################################################################################
# Stage: base
########################################################################################################################

FROM php:7.4.3-fpm-buster as base
RUN apt-get update \
 && apt-get install -y libicu-dev git unzip \
 && docker-php-ext-install -j$(nproc) intl pdo
RUN adduser --disabled-password --gecos '' app
RUN mkdir /app/
RUN chown -R app: /app/
WORKDIR /app/

########################################################################################################################
# Stage: build
########################################################################################################################

FROM base as build
COPY --from=composer /usr/bin/composer /usr/bin/composer
COPY composer* /app/
USER app
RUN composer install

########################################################################################################################
# Stage: production
########################################################################################################################

FROM base as production
COPY --from=build /app/ /app/
COPY . /app/
